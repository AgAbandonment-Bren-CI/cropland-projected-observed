---
title: "Brazil Cropland"
author: "Nick McManus"
date: '2022-07-28'
output: 
 html_document: 
    toc: yes
    toc_float: yes
    theme: cerulean
    code_folding: hide
    smooth_scroll: yes
    collapsed: yes
---

```{r setup, include=TRUE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)  #polygons
library(raster) #raster package
library(terra)  #newer/faster/better raster package
library(rnaturalearth)  #administrative boundaries data
library(exactextractr)  #extracting what's underneath polys, points
library(kableExtra) #tables
library(tidyverse) #always
library(caret) # for confusion matrix
```

## ROI

This analysis will be focusing on cropland and datasets in Brazil. 

```{r}
# get brazil from rnaturalearth data
brazil <- ne_countries(
  scale = "medium",
  country = "Brazil",
  returnclass = "sf") %>% 
  dplyr::select(sovereignt)

# plot to check
ggplot() +
  geom_sf(data = brazil)
```


## Projected Cropland {.tabset}

### Chen et al., 2022
First read in projected 2020 cropland from Chen et al. 2022. Then, crop and mask this global projection to just Brazil. Finally, reclassify the raster to keep only pixels representing cropland.

Source: Chen, G., Li, X., & Liu, X. (2022). Global land projection based on plant functional types with a 1-km resolution under socio-climatic scenarios. Scientific Data, 9(1), 125. https://doi.org/10.1038/s41597-022-01208-6

```{r}
# read in GeoTiff for SSP1 scenario (other scenarios will be examined later)
chen_ssp1_2020_global <- rast("data/chen/global_PFT_SSP1_RCP26_2020.tif")

# transform brazil to crop chen raster bc it's faster than re-projecting the whole global raster
brazil_trans <- brazil %>% 
  st_transform(crs = crs(chen_ssp1_2020_global)) %>% 
  vect() # vect is more agreeable to rasts

# crop and mask chen data to brazil_trans vector, then project back to our desired crs
chen_ssp1_2020_brazil <- chen_ssp1_2020_global %>% 
  crop(brazil_trans) %>% 
  mask(brazil_trans) %>% 
  terra::project(y = crs(brazil))

# reclassify to isolate just cropland from the raster
# values assigned 0 and 10 for later visualization and calculations
chen_crop_ssp1_2020_brazil <- chen_ssp1_2020_brazil
chen_crop_ssp1_2020_brazil[chen_crop_ssp1_2020_brazil != 18] <- 0 # if value isn't 18, make 0
chen_crop_ssp1_2020_brazil[chen_crop_ssp1_2020_brazil == 18] <- 10 # if value is 18, make 10

plot(chen_crop_ssp1_2020_brazil)
```
 

 
### Cao et al., 2021

This is where I will read in Cao data

Source: 
```{r}
cao_ssp1_2020_global <- rast("data/cao/globalCropland_2020CE_SSP1_RCP26.tif")


```



## Observed Cropland

For observed cropland in Brazil, we will use data from MapBiomas (Collection 6), which uses Landsat mosaics to classify LULC at 30m resolution. (More information and GeoTiff source found at: https://mapbiomas.org/en/colecoes-mapbiomas-1?cama_set_language=en)

```{r, eval=FALSE}
# WARNING: below analysis (aggregate step) will take a long time to run!
# Once run, the last line of code in this chunk will save the intermediate raster locally.
# If this has been already run once, skip running this chunk and move on to next


# read in GeoTiff
mapbio_2020 <- rast("data/mapbiomas/mapbiomas_brasil_coverage_2020.tif")

# change resolution from 30m to roughly 1km
# to figure out factor that gets res closest to target raster (Chen), use this:
    factor <- ceiling(res(chen_crop_ssp1_2020_brazil)[1]/res(mapbio_2020)[1])
    factor

# now change resolution using terra:aggregate()
mapbio_2020_agg <- aggregate(mapbio_2020,   #raster 
                            fact = 34,            #agg factor (positive int)
                            fun = "modal",        #categorical values in raster
                            na.rm = TRUE)         #don't drop entire aggregation bc of one NA

# resample lower res mapbiomas using Chen data to ensure same resolution (fine-tuning the res)
mapbio_2020_resamp <- resample(mapbio_2020_agg, chen_crop_ssp1_2020_brazil, method = "near")

# because crs of mapbiomas and chen rasters are different, repeat process of
# transforming brazil for purposes of cropping and masking
brazil_trans2 <- brazil %>% 
  st_transform(crs = crs(mapbio_2020_resamp)) %>% 
  vect() 

# crop and mask mapbiomas layer to ROI
mapbio_2020_cropped <- mapbio_2020_resamp %>% 
  crop(brazil_trans2, mask = TRUE)

# save intermediate raster
#writeRaster(mapbio_2020_cropped, "data/mapbiomas/mapbiomas_2020_cropped.tif")
```


Now that Mapbiomas data has been aggregated, resampled, and cropped, it's time to reclassify the raster to select for LULC categories of interest. Cropland data for analysis will be defined as "agriculture" from the MapBiomas classification, which includes temporary and perennial crops but omits pasture and mosaic agriculture. Later on, we want to see how including the mosaic agriculture and pasture land classification affects the (agreement) between Chen and Mapbiomas datasets. This requires creating `mapbio_crop_2020_mosaic`, a separate classification that includes mosaic agriculture.
```{r}
# if above code chunk has been previously run, read in raster for analysis:
mapbio_2020_cropped <- rast("data/mapbiomas/mapbiomas_2020_cropped.tif")

# create reclassification matrix to combine and keep only cropland categories
reclass_df <- c(3, 0,   #forest formation
                4, 0,   #savanna formation
                5, 0,   #mangrove
                49, 0,  #wooded restinga
                11, 0,  #wetlands
                12, 0,  #grassland
                32, 0,  #salt flat
                29, 0,  #rocky outcrop
                13, 0,  #other nonforest formations
                15, 0,  #pasture
                9, 0,   #forest plantation
                21, 0,  #mosaic ag and pasture
                23, 0,  #beach, dune, and sand spot
                24, 0,  #urban area
                30, 0,  #mining
                25, 0,  #other non vegetated areas
                33, 0,  # river, lake, ocean
                31, 0,  #aquaculture
                27, 0,  #non observed
                39, 1,  #soybean
                20, 1,  #sugar cane
                40, 1,  #rice
                41, 1,  #other temp crops
                46, 1,  #coffee
                47, 1,  #citrus
                48, 1)  #other perennial crops

# reshape df into matrix with columns and rows
reclass_m <- matrix(reclass_df, ncol = 2, byrow = TRUE)

# use terra:classify() to reclassify raster values based on matrix
mapbio_2020_reclass <- classify(mapbio_2020_cropped, reclass_m)

# crs do not match, so use terra::project() to match with chen raster
mapbio_crop_2020 <- project(mapbio_2020_reclass, crs(chen_crop_ssp1_2020_brazil), method = "near")



# include ag mosaic in new reclassification
reclass_df_mosaic <- c(3, 0,   #forest formation
                4, 0,   #savanna formation
                5, 0,   #mangrove
                49, 0,  #wooded restinga
                11, 0,  #wetlands
                12, 0,  #grassland
                32, 0,  #salt flat
                29, 0,  #rocky outcrop
                13, 0,  #other nonforest formations
                15, 0,  #pasture
                9, 0,   #forest plantation
                21, 1,  #mosaic ag and pasture
                23, 0,  #beach, dune, and sand spot
                24, 0,  #urban area
                30, 0,  #mining
                25, 0,  #other non vegetated areas
                33, 0,  # river, lake, ocean
                31, 0,  #aquaculture
                27, 0,  #non observed
                39, 1,  #soybean
                20, 1,  #sugar cane
                40, 1,  #rice
                41, 1,  #other temp crops
                46, 1,  #coffee
                47, 1,  #citrus
                48, 1)  #other perennial crops

reclass_m_mosaic <- matrix(reclass_df_mosaic, ncol = 2, byrow = TRUE)

mapbio_2020_reclass_mosaic <- classify(mapbio_2020_cropped, reclass_m_mosaic)

mapbio_crop_2020_mosaic <- project(mapbio_2020_reclass_mosaic, crs(chen_crop_ssp1_2020_brazil), method = "near")

```



## Confusion matrix

Now we will compare projects vs observed cropland within Brazil. This will be done using a confusion matrix.

### Chen vs. Mapbiomas {.tabset}

#### Only cropland

Create confusion matrix to view sensitivity (true positive) and specificity of Chen SSP1 2020 and MapBiomas 2020 (cropland only) data.
```{r}
# add chen and mapbiomas rasters
chen_mapbio_crop_2020 <- mapbio_crop_2020 + chen_crop_ssp1_2020_brazil

# return frequency of each value (0, 1, 10, 11) in new raster
counts <- freq(chen_mapbio_crop_2020)

# break up freq values by classification meaning
nocrop <- counts[1, 3]
crop_mapbio_only <- counts[2, 3]
crop_chen_only <- counts[3,3]
crop_both <- counts[4,3]


## break down into values for confusion matrix

# number of real positive cases (P), pixels for which mapbiomas observed cropland
p <- crop_mapbio_only + crop_both
# number of real negative cases (N), pixels for which mapbiomas did not observe cropland
n <- nocrop + crop_chen_only

# true positive
tp <- crop_both
# false positive
fp <- crop_chen_only
# true negative
tn <- nocrop
# false negative
fn <- crop_mapbio_only

## percentages/rates:
# sensitivity (true positive rate)
tpr <- tp/p
# specificity (true negative rate)
tnr <- tn/n
# false positive rate
fpr <- fp/n
# false negative rate
fnr <- fn/p

#accuracy 
acc <- (tp + tn)/(p+n)
#precision (positive predictive value)
ppv <- tp/(tp + fp)

cm_2020 <- matrix(c(tp, fn, fp, tn), ncol=2, byrow=TRUE)
colnames(cm_2020) <- c("Predicted Pos", "Predicted Neg")
rownames(cm_2020) <- c("Observed Pos", "Observed Neg")

# cm of rates
cm_2020_perc <- matrix(c(tpr, fnr, fpr, tnr), ncol=2, byrow=TRUE)
colnames(cm_2020_perc) <- c("Predicted Pos", "Predicted Neg")
rownames(cm_2020_perc) <- c("Observed Pos", "Observed Neg")

cm_2020
cm_2020_perc
acc
ppv

```
can I do a `r cm_2020`


Visualize overlap between crop classifications of Chen and MapBiomas rasters.
```{r}
# plot combined layer
plot(chen_mapbio_crop_2020, col = c("red", "yellow", "slateblue", "black"))

# add legend! convert to vect and sf then put in ggplot?
```

                                  

#### Cropland + Mosaic ag

Check how overlap and confusion matrix change if mosaic ag and pasture is included into MapBiomas 2020 data
```{r}
# add chen and mapbiomas rasters 
chen_mapbio_crop_2020_mosaic <- mapbio_crop_2020_mosaic + chen_crop_ssp1_2020_brazil

# return frequency of each value (0, 1, 10, 11) in new raster
counts <- freq(chen_mapbio_crop_2020_mosaic)
counts

# break up freq values ba
nocrop <- counts[1, 3]
crop_mapbio_only <- counts[2, 3]
crop_chen_only <- counts[3,3]
crop_both <- counts[4,3]


## break down into values for confusion matrix

# number of real positive cases (P), pixels for which mapbiomas observed cropland
p <- crop_mapbio_only + crop_both
# number of real negative cases (N), pixels for which mapbiomas did not observe cropland
n <- nocrop + crop_chen_only

# true positive
tp <- crop_both
# false positive
fp <- crop_chen_only
# true negative
tn <- nocrop
# false negative
fn <- crop_mapbio_only

## percentages:
# sensitivity (true positive rate)
tpr <- tp/p
# specificity (true negative rate)
tnr <- tn/n
# false positive rate
fpr <- fp/n
# false negative rate
fnr <- fn/p

#accuracy 
acc <- (tp + tn)/(p+n)
#precision (positive predictive value)
ppv <- tp/(tp + fp)


cm_2020_mosaic <- matrix(c(tp, fn, fp, tn), ncol=2, byrow=TRUE)
colnames(cm_2020_mosaic) <- c("Predicted Positive", "Predicted Negative")
rownames(cm_2020_mosaic) <- c("Observed Positive", "Observed Negative")
cm_2020_mosaic

cm_2020_mosaic_perc <- matrix(c(tpr, fnr, fpr, tnr), ncol=2, byrow=TRUE)
colnames(cm_2020_mosaic_perc) <- c("Predicted Positive", "Predicted Negative")
rownames(cm_2020_mosaic_perc) <- c("Observed Positive", "Observed Negative")
cm_2020_mosaic_perc

acc
ppv
```

```{r}
# plot combined layer
plot(chen_mapbio_crop_2020_mosaic, col = c("red", "yellow", "slateblue", "black"))
```


### Cao vs. Mapbiomas




## Checking "baseline" datasets

Checking the sensitivity and specificity of Chen 2015 and Mapbiomas 2015, both considered "observed" models. This requires reading in and repeating several previous steps for new raster layer. Then we will create the confusion matrices and visualize the results. 

### Read in data

First read in, crop, mask, and reclassify 2015 Chen raster
```{r}
# read in GeoTiff for 2015 Chen
chen_2015_global <- rast("data/chen/global_PFT_2015.tif")

# crop and mask chen data to brazil_trans vector, then project back to our desired crs
chen_2015_brazil <- chen_2015_global %>% 
  crop(brazil_trans) %>% 
  mask(brazil_trans) %>% 
  terra::project(y = crs(brazil))

# isolate just cropland from the raster
chen_crop_2015_brazil <- chen_2015_brazil
chen_crop_2015_brazil[chen_crop_2015_brazil != 18] <- 0 # if value isn't 18, make 0
chen_crop_2015_brazil[chen_crop_2015_brazil == 18] <- 10 # if value is 18, make 10

#plot(chen_crop_2015_brazil)
```

Next read in, crop, mask, and reclassify 2015 MapBiomas raster
```{r, eval=FALSE}
## WARNING: below analysis (aggregate step) will take a long time to run!
## Once run, the last line of code in this chunk will save the intermediate raster locally.
## If this has been already run once, skip running this chunk and move on to next


# read in GeoTiff
mapbio_2015 <- rast("data/mapbiomas/mapbiomas_brasil_coverage_2015.tif")

# change resolution from 30m to roughly 1km
# to figure out factor that gets res closest to target raster (Chen), use this:
    factor <- ceiling(res(chen_crop_2015_brazil)[1]/res(mapbio_2015)[1])
    factor

# now change resolution using terra:aggregate()
mapbio_2015_agg <- aggregate(mapbio_2015,   #raster 
                             fact = 34,            #agg factor (positive int)
                             fun = "modal",        #categorical values in raster
                             na.rm = TRUE)         #don't drop entire aggregation bc of one NA

# resample lower res mapbiomas using Chen data to ensure same resolution (fine-tuning the res)
mapbio_2015_resamp <- resample(mapbio_2015_agg, chen_crop_2015_brazil, method = "near")

# because crs of mapbiomas and chen rasters are different, repeat process of
# transforming brazil for purposes of cropping and masking
brazil_trans2 <- brazil %>% 
  st_transform(crs = crs(mapbiomas_2015_resamp)) %>% 
  vect() 

# crop and mask mapbiomas layer to ROI
mapbio_2015_cropped <- mapbio_2015_resamp %>% 
  crop(brazil_trans2, mask = TRUE)

# save intermediate raster
#writeRaster(mapbio_2015_cropped, "data/mapbiomas/mapbiomas_2015_cropped.tif")

```

```{r}
# read in raster if previous chunk has already been run:
mapbio_2015_cropped <- rast("data/mapbiomas/mapbiomas_2015_cropped.tif")

# use previously created matrix for cropland onlyd
mapbio_2015_reclass <- classify(mapbio_2015_cropped, reclass_m)
# use terra::project() to match with chen raster
mapbio_crop_2015 <- project(mapbio_2015_reclass, crs(chen_crop_2015_brazil), method = "near")


# now use matrix including mosaic cropland
mapbio_2015_reclass_mosaic <- classify(mapbio_2015_cropped, reclass_m_mosaic)
# project to chen raster
mapbio_crop_2015_mosaic <- project(mapbio_2015_reclass_mosaic, crs(chen_crop_2015_brazil), method = "near")
```


### Confusion matrices for 2015 datasets {.tabset}

#### Only cropland
```{r}
# add chen and mapbiomas rasters 
chen_mapbio_crop_2015 <- mapbio_crop_2015 + chen_crop_2015_brazil

# return frequency of each value (0, 1, 10, 11) in new raster
counts2015 <- freq(chen_mapbio_crop_2015)
counts2015

# break up freq values ba
nocrop_2015 <- counts2015[1, 3]
crop_mapbio_only_2015 <- counts2015[2, 3]
crop_chen_only_2015 <- counts2015[3,3]
crop_both_2015 <- counts2015[4,3]


## break down into values for confusion matrix

# number of real positive cases (P), pixels for which mapbiomas observed cropland
p2 <- crop_mapbio_only_2015 + crop_both_2015
# number of real negative cases (N), pixels for which mapbiomas did not observe cropland
n2 <- nocrop_2015 + crop_chen_only_2015

# true positive
tp2 <- crop_both_2015
# false positive
fp2 <- crop_chen_only_2015
# true negative
tn2 <- nocrop_2015
# false negative
fn2 <- crop_mapbio_only_2015

## percentages/rates:
# sensitivity (true positive rate)
tpr2 <- tp2/p2
# specificity (true negative rate)
tnr2 <- tn2/n2
# false positive rate
fpr2 <- fp2/n2
# false negative rate
fnr2 <- fn2/p2

#accuracy 
acc2 <- (tp2 + tn2)/(p2+n2)
#precision (positive predictive value)
ppv2 <- tp2/(tp2 + fp2)


cm_2015 <- matrix(c(tp2, fn2, fp2, tn2), ncol=2, byrow=TRUE)
colnames(cm_2015) <- c("Predicted Positive", "Predicted Negative")
rownames(cm_2015) <- c("Observed Positive", "Observed Negative")
cm_2015

cm_2015_perc <- matrix(c(tpr2, fnr2, fpr2, tnr2), ncol=2, byrow=TRUE)
colnames(cm_2015_perc) <- c("Predicted Positive", "Predicted Negative")
rownames(cm_2015_perc) <- c("Observed Positive", "Observed Negative")
cm_2015_perc

acc2
ppv2
```
```{r}
# plot combined layer
plot(chen_mapbio_crop_2015, col = c("red", "yellow", "slateblue", "black"))
```



#### Cropland + Mosaic ag
```{r}
# add chen and mapbiomas rasters 
chen_mapbio_crop_2015_mosaic <- mapbio_crop_2015_mosaic + chen_crop_2015_brazil

# return frequency of each value (0, 1, 10, 11) in new raster
counts2015 <- freq(chen_mapbio_crop_2015_mosaic)
counts2015

# break up freq values ba
nocrop_2015 <- counts2015[1, 3]
crop_mapbio_only_2015 <- counts2015[2, 3]
crop_chen_only_2015 <- counts2015[3,3]
crop_both_2015 <- counts2015[4,3]

## break down into values for confusion matrix

# number of real positive cases (P), pixels for which mapbiomas observed cropland
p2 <- crop_mapbio_only_2015 + crop_both_2015
# number of real negative cases (N), pixels for which mapbiomas did not observe cropland
n2 <- nocrop_2015 + crop_chen_only_2015

# true positive
tp2 <- crop_both_2015
# false positive
fp2 <- crop_chen_only_2015
# true negative
tn2 <- nocrop_2015
# false negative
fn2 <- crop_mapbio_only_2015

## percentages/rates:
# sensitivity (true positive rate)
tpr2 <- tp2/p2
# specificity (true negative rate)
tnr2 <- tn2/n2
# false positive rate
fpr2 <- fp2/n2
# false negative rate
fnr2 <- fn2/p2

#accuracy 
acc2 <- (tp2 + tn2)/(p2+n2)
#precision (positive predictive value)
ppv2 <- tp2/(tp2 + fp2)


cm_2015_mosaic <- matrix(c(tp2, fn2, fp2, tn2), ncol=2, byrow=TRUE)
colnames(cm_2015_mosaic) <- c("Predicted Positive", "Predicted Negative")
rownames(cm_2015_mosaic) <- c("Observed Positive", "Observed Negative")
cm_2015_mosaic

cm_2015_mosaic_perc <- matrix(c(tpr2, fnr2, fpr2, tnr2), ncol=2, byrow=TRUE)
colnames(cm_2015_mosaic_perc) <- c("Predicted Positive", "Predicted Negative")
rownames(cm_2015_mosaic_perc) <- c("Observed Positive", "Observed Negative")
cm_2015_mosaic_perc

acc2
ppv2
```

```{r}
# plot combined layer
plot(chen_mapbio_crop_2015_mosaic, col = c("red", "yellow", "slateblue", "black"))
```


