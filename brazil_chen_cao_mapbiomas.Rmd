---
title: "Brazil Cropland"
author: "Nick McManus"
date: '2022-07-28'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)  # polygons
library(raster) #raster package
library(terra)  # newer/faster/better raster package
library(rnaturalearth)  #administrative boundaries data
library(exactextractr)  # extracting what's underneath polys, points
library(kableExtra)
library(tidyverse)
```

## ROI

Let's start with looking at Brazil, our region of interest

```{r}
# get brazil from rnaturalearth data
brazil <- ne_countries(
  scale = "medium",
  country = "Brazil",
  returnclass = "sf") %>% 
  dplyr::select(sovereignt)

# plot to check
ggplot() +
  geom_sf(data = brazil)
```

```{r}
# define crs so it's the same across everything
my_crs <- st_crs(brazil)
```


## Projected Cropland

### Chen et al. 2022
First read in projected 2020 cropland from Chen et al. 2022. Then, crop and mask this global projection to just Brazil. Finally, reclassify the raster to keep only pixels representing cropland.

Source: Chen, G., Li, X., & Liu, X. (2022). Global land projection based on plant functional types with a 1-km resolution under socio-climatic scenarios. Scientific Data, 9(1), 125. https://doi.org/10.1038/s41597-022-01208-6

```{r}
# read in GeoTiff for SSP1 scenario (other scenarios will be examined later)
chen_ssp1_2020_global <- rast("data/chen/global_PFT_SSP1_RCP26_2020.tif")

# transform brazil to crop bc it's faster than re projecting the whole global raster
brazil_trans <- brazil %>% 
  st_transform(crs = crs(chen_ssp1_2020_global)) %>% 
  vect() # vect is more agreeable to rasts

# crop and mask chen data to brazil then project back to our dfs
chen_ssp1_2020_brazil <- chen_ssp1_2020_global %>% 
  crop(brazil_trans) %>% 
  mask(brazil_trans) %>% 
  terra::project(y = crs(brazil))


# isolate just cropland from the raster
chen_crop_ssp1_2020_brazil <- chen_ssp1_2020_brazil
chen_crop_ssp1_2020_brazil[chen_crop_ssp1_2020_brazil != 18] <- 0 # if value isn't 18, make 0
chen_crop_ssp1_2020_brazil[chen_crop_ssp1_2020_brazil == 18] <- 10 # if value is 18, make 10


plot(chen_crop_ssp1_2020_brazil)
```
 
 
 
### Cao et al., 2021
This is where I will read in Cao data

Source: 
```{r}
cao_ssp1_2020_global <- rast("data/cao/globalCropland_2020CE_SSP1_RCP26.tif")

```







## Observed Cropland
For observed cropland in Brazil, we will use data from MapBiomas (Collection 6), which uses Landsat mosaics to classify LULC at 30m resolution. (More information and GeoTiff source found at: https://mapbiomas.org/en/colecoes-mapbiomas-1?cama_set_language=en)
Cropland data for analysis will be defined as "Agriculture" from the MapBiomas classification, which includes temporary and perennial crops but omits pasture and mosaic agriculture.

```{r}
# read in GeoTiff
mapbiomas_2020 <- rast("data/mapbiomas_brasil_coverage_2020.tif")

# change resolution from 30m to roughly 1km
# to figure out factor that gets res closest to target raster (Chen), use this:
    #factor <- ceiling(res(chen_cropland_ssp1_2020)[1]/res(mapbiomas)[1])
    #factor
# now change resolution using terra:aggregate()
# NOTE: this will take a while to process!
mapbiomas_2020_agg <- aggregate(mapbiomas_2020,   #raster 
                            fact = 34,            #agg factor (positive int)
                            fun = "modal",        #categorical values in raster
                            na.rm = TRUE)         #don't drop entire aggregation bc of one NA

# resample lower res mapbiomas_agg using Chen data to ensure same resolution
mapbiomas_2020_resamp <- resample(mapbiomas_2020_agg, chen_crop_ssp1_2020_brazil, method = "near")

#creating new ROI shouldn't be necessary if crs(chen)==crs(mapbiomas). This isn't the case and needs to be fixed!
brazil_trans2 <- brazil %>% 
  st_transform(crs = crs(mapbiomas_2020_resamp)) %>% 
  vect() # vect is more agreeable to rasts

# crop and mask mapbiomas layer to ROI
mapbiomas_2020_cropped <- mapbiomas_2020_resamp %>% 
  crop(brazil_trans2, mask = TRUE)

# create reclassification matrix to combine and keep only cropland categories
reclass_df <- c(3, 0,   #forest formation
                4, 0,   #savanna formation
                5, 0,   #mangrove
                49, 0,  #wooded restinga
                11, 0,  #wetlands
                12, 0,  #grassland
                32, 0,  #salt flat
                29, 0,  #rocky outcrop
                13, 0,  #other nonforest formations
                15, 0,  #pasture
                9, 0,   #forest plantation
                21, 0,  #mosaic ag and pasture
                23, 0,  #beach, dune, and sand spot
                24, 0,  #urban area
                30, 0,  #mining
                25, 0,  #other non vegetated areas
                33, 0,  # river, lake, ocean
                31, 0,  #aquaculture
                27, 0,  #non observed
                39, 1,  #soybean
                20, 1,  #sugar cane
                40, 1,  #rice
                41, 1,  #other temp crops
                46, 1,  #coffee
                47, 1,  #citrus
                48, 1)  #other perennial crops

# reshape df into matrix with columns and rows
reclass_m <- matrix(reclass_df,
                    ncol = 2,
                    byrow = TRUE)

# use terra:classify() to reclassify raster based on matrix
mapbiomas_2020_reclass <- classify(mapbiomas_2020_cropped, reclass_m)

# use if you want to assign all 0 pixels to no data value
#mapbiomas_reclass[mapbiomas_reclass == 0] <- NA


# save intermediate rasters to save on computing time in future
writeRaster(mapbiomas_2020_reclass, "data/mapbiomas_brasil_2020_cropland.tif")
# skip steps above and read in saved raster below
mapbiomas_crop_2020 <- rast("data/mapbiomas_brasil_2020_cropland.tif")


plot(mapbiomas_crop_2020)
```



Now we will add Chen and MapBiomas rasters to determine overlap between crop classifications
```{r}
chen_mapbiomas_crop <- mapbiomas_crop_2020 + chen_crop_ssp1_2020_brazil
plot(chen_mapbiomas_crop)

counts <- freq(chen_mapbiomas_crop)
counts

nocrop <- counts[1, 3]
crop_mapbiomas_only <- counts[2, 3]
crop_chen_only <- counts[3,3]
crop_both <- counts[4,3]

total <- nocrop + crop_mapbiomas_only + crop_chen_only + crop_both
total
ncell(chen_mapbiomas_crop) #discrepancy between two numbers...
```
