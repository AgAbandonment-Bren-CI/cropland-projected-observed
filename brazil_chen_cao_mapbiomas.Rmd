---
title: "Brazil Cropland"
author: "Nick McManus"
date: '2022-07-28'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)  #polygons
library(raster) #raster package
library(terra)  #newer/faster/better raster package
library(rnaturalearth)  #administrative boundaries data
library(exactextractr)  #extracting what's underneath polys, points
library(kableExtra) #tables
library(tidyverse) #always
library(caret) # for confusion matrix
```

## ROI

This analysis will be focusing on cropland and datasets in Brazil. 

```{r}
# get brazil from rnaturalearth data
brazil <- ne_countries(
  scale = "medium",
  country = "Brazil",
  returnclass = "sf") %>% 
  dplyr::select(sovereignt)

# plot to check
#ggplot() +
#  geom_sf(data = brazil)
```


## Projected Cropland {.tabset}

### Chen et al., 2022
First read in projected 2020 cropland from Chen et al. 2022. Then, crop and mask this global projection to just Brazil. Finally, reclassify the raster to keep only pixels representing cropland.

Source: Chen, G., Li, X., & Liu, X. (2022). Global land projection based on plant functional types with a 1-km resolution under socio-climatic scenarios. Scientific Data, 9(1), 125. https://doi.org/10.1038/s41597-022-01208-6

```{r}
# read in GeoTiff for SSP1 scenario (other scenarios will be examined later)
chen_ssp1_2020_global <- rast("data/chen/global_PFT_SSP1_RCP26_2020.tif")

# transform brazil to crop chen raster bc it's faster than re-projecting the whole global raster
brazil_trans <- brazil %>% 
  st_transform(crs = crs(chen_ssp1_2020_global)) %>% 
  vect() # vect is more agreeable to rasts

# crop and mask chen data to brazil_trans vector, then project back to our desired crs
chen_ssp1_2020_brazil <- chen_ssp1_2020_global %>% 
  crop(brazil_trans) %>% 
  mask(brazil_trans) %>% 
  terra::project(y = crs(brazil))

# reclassify to isolate just cropland from the raster
# `chen_crop_ssp1_2020_brazil` will be used for mapping/visualization
chen_crop_ssp1_2020_brazil <- chen_ssp1_2020_brazil
chen_crop_ssp1_2020_brazil[chen_crop_ssp1_2020_brazil != 18] <- 0 # if value isn't 18, make 0
chen_crop_ssp1_2020_brazil[chen_crop_ssp1_2020_brazil == 18] <- 10 # if value is 18, make 10

# this reclassification will be used for creating a confusion matrix
# values need to match mapbiomas
chen_crop_ssp1_2020_brazil_cm <- chen_ssp1_2020_brazil
chen_crop_ssp1_2020_brazil_cm[chen_crop_ssp1_2020_brazil_cm != 18] <- 0 # if value isn't 18, make 0
chen_crop_ssp1_2020_brazil_cm[chen_crop_ssp1_2020_brazil_cm == 18] <- 1 # if value is 18, make 1

#plot(chen_crop_ssp1_2020_brazil)
```
 

 
### Cao et al., 2021

This is where I will read in Cao data

Source: 
```{r}
cao_ssp1_2020_global <- rast("data/cao/globalCropland_2020CE_SSP1_RCP26.tif")


```



## Observed Cropland

For observed cropland in Brazil, we will use data from MapBiomas (Collection 6), which uses Landsat mosaics to classify LULC at 30m resolution. (More information and GeoTiff source found at: https://mapbiomas.org/en/colecoes-mapbiomas-1?cama_set_language=en)
Cropland data for analysis will be defined as "Agriculture" from the MapBiomas classification, which includes temporary and perennial crops but omits pasture and mosaic agriculture.

```{r, eval=FALSE}
# WARNING: below analysis (aggregate step) will take a long time to run!
# Once run, the last line of code in this chunk will save the intermediate raster locally.
# If this has been already run once, skip running this chunk and move on to next


# read in GeoTiff
mapbiomas_2020 <- rast("data/mapbiomas/mapbiomas_brasil_coverage_2020.tif")

# change resolution from 30m to roughly 1km
# to figure out factor that gets res closest to target raster (Chen), use this:
    factor <- ceiling(res(chen_crop_ssp1_2020_brazil)[1]/res(mapbiomas_2020)[1])
    factor

# now change resolution using terra:aggregate()
mapbiomas_2020_agg <- aggregate(mapbiomas_2020,   #raster 
                            fact = 34,            #agg factor (positive int)
                            fun = "modal",        #categorical values in raster
                            na.rm = TRUE)         #don't drop entire aggregation bc of one NA

# resample lower res mapbiomas using Chen data to ensure same resolution (fine-tuning the res)
mapbiomas_2020_resamp <- resample(mapbiomas_2020_agg, chen_crop_ssp1_2020_brazil, method = "near")

# because crs of mapbiomas and chen rasters are different, repeat process of
# transforming brazil for purposes of cropping and masking
brazil_trans2 <- brazil %>% 
  st_transform(crs = crs(mapbiomas_2020_resamp)) %>% 
  vect() 

# crop and mask mapbiomas layer to ROI
mapbiomas_2020_cropped <- mapbiomas_2020_resamp %>% 
  crop(brazil_trans2, mask = TRUE)

# save intermediate raster
#writeRaster(mapbiomas_2020_cropped, "data/mapbiomas/mapbiomas_2020_cropped.tif")
```


Now that Mapbiomas data has been aggregated, resampled, and cropped, it's time to reclassify the raster to select for LULC categories of interest. For `mapbiomas_crop_2020`, we want to only include annual and perennial crops. Later on, we want to see how including the mosaic agriculture and pasture land classification affects the (agreement) between Chen and Mapbiomas datasets. This requires creating `mapbiomas_crop_2020_mosaic`, a separate classification that includes mosaic agriculture.
```{r}
# if above code chunk has been previously run, read in raster for analysis:
mapbiomas_2020_cropped <- rast("data/mapbiomas/mapbiomas_2020_cropped.tif")

# create reclassification matrix to combine and keep only cropland categories
reclass_df <- c(3, 0,   #forest formation
                4, 0,   #savanna formation
                5, 0,   #mangrove
                49, 0,  #wooded restinga
                11, 0,  #wetlands
                12, 0,  #grassland
                32, 0,  #salt flat
                29, 0,  #rocky outcrop
                13, 0,  #other nonforest formations
                15, 0,  #pasture
                9, 0,   #forest plantation
                21, 0,  #mosaic ag and pasture
                23, 0,  #beach, dune, and sand spot
                24, 0,  #urban area
                30, 0,  #mining
                25, 0,  #other non vegetated areas
                33, 0,  # river, lake, ocean
                31, 0,  #aquaculture
                27, 0,  #non observed
                39, 1,  #soybean
                20, 1,  #sugar cane
                40, 1,  #rice
                41, 1,  #other temp crops
                46, 1,  #coffee
                47, 1,  #citrus
                48, 1)  #other perennial crops

# reshape df into matrix with columns and rows
reclass_m <- matrix(reclass_df, ncol = 2, byrow = TRUE)

# use terra:classify() to reclassify raster values based on matrix
mapbiomas_2020_reclass <- classify(mapbiomas_2020_cropped, reclass_m)

# crs do not match, so use terra::project() to match with chen raster
mapbiomas_crop_2020 <- project(mapbiomas_2020_reclass, crs(chen_crop_ssp1_2020_brazil), method = "near")



# include ag mosaic in new reclassification
reclass_df_mosaic <- c(3, 0,   #forest formation
                4, 0,   #savanna formation
                5, 0,   #mangrove
                49, 0,  #wooded restinga
                11, 0,  #wetlands
                12, 0,  #grassland
                32, 0,  #salt flat
                29, 0,  #rocky outcrop
                13, 0,  #other nonforest formations
                15, 0,  #pasture
                9, 0,   #forest plantation
                21, 1,  #mosaic ag and pasture
                23, 0,  #beach, dune, and sand spot
                24, 0,  #urban area
                30, 0,  #mining
                25, 0,  #other non vegetated areas
                33, 0,  # river, lake, ocean
                31, 0,  #aquaculture
                27, 0,  #non observed
                39, 1,  #soybean
                20, 1,  #sugar cane
                40, 1,  #rice
                41, 1,  #other temp crops
                46, 1,  #coffee
                47, 1,  #citrus
                48, 1)  #other perennial crops

reclass_m_mosaic <- matrix(reclass_df_mosaic, ncol = 2, byrow = TRUE)

mapbiomas_2020_reclass_mosaic <- classify(mapbiomas_2020_cropped, reclass_m_mosaic)

mapbiomas_crop_2020_mosaic <- project(mapbiomas_2020_reclass_mosaic, crs(chen_crop_ssp1_2020_brazil), method = "near")

```



## Confusion matrix

Now we will compare projects vs observed cropland within Brazil. This will be done using a confusion matrix.

### Chen vs. Mapbiomas {.tabset}

#### Only cropland

Create confusion matrix to view sensitivity (true positive) and specificity of Chen SSP1 2020 and MapBiomas 2020 (cropland only) data.
```{r}
# first convert rasters to vectors
vals_chen <- terra::values(chen_crop_ssp1_2020_brazil_cm)
vals_mapbio <- terra::values(mapbiomas_crop_2020)

#turn vects into factors of same length
expected_val_2020 <- factor(vals_mapbio)
predicted_val_2020 <- factor(vals_chen)
 
#Creating confusion matrix
cm_chen_mapbio_2020 <- confusionMatrix(data=predicted_val_2020, reference = expected_val_2020)
 
#Display results 
cm_chen_mapbio_2020
table(expected_val_2020, predicted_val_2020)
```

here I'm seeing if confusion matrix is more accurate by masking layers by each other and removing some NAs (it is slightly)
```{r}
# mask chen and mapbiomas by each other to make sure NA values are equal

test <- chen_crop_ssp1_2020_brazil_cm %>% 
  mask(mapbiomas_crop_2020)

vals_test <- values(test)
predicted_test <- factor(vals_test)

cm_test <- confusionMatrix(data=predicted_test, reference = expected_val_2020, mode = "sens_spec")
cm_test
cm_chen_mapbio_2020
```



Visualize overlap between crop classifications of Chen and MapBiomas rasters.
```{r}
# add chen and mapbiomas rasters
chen_mapbiomas_crop_2020 <- mapbiomas_crop_2020 + chen_crop_ssp1_2020_brazil

# plot combined layer
plot(chen_mapbiomas_crop_2020)
```


Old code for reference: DELETE LATER!
```{r}
# return frequency of each value (0, 1, 10, 11) in new raster
counts <- freq(chen_mapbiomas_crop_2020)
counts

# break up freq values ba
nocrop <- counts[1, 3]
crop_mapbiomas_only <- counts[2, 3]
crop_chen_only <- counts[3,3]
crop_both <- counts[4,3]

# determine total number of pixels with values for calculating percentages later
total <- nocrop + crop_mapbiomas_only + crop_chen_only + crop_both
total



# break down into values for confusion matrix

# number of real positive cases (P), pixels for which mapbiomas observed cropland
p <- crop_mapbiomas_only + crop_both
# number of real negative cases (N), pixels for which mapbiomas did not observe cropland
n <- nocrop + crop_chen_only

# true positive
tp <- crop_both
# false positive
fp <- crop_chen_only
# true negative
tn <- nocrop
# false negative
fn <- crop_mapbiomas_only

#percentages:
# sensitivity (true positive rate)
tpr <- tp/p
# specificity (true negative rate)
tnr <- tn/n
# false positive rate
fpr <- fp/n
# false negative rate
fnr <- fn/p

#accuracy 
acc <- (tp + tn)/(p+n)


conf_matrix <- matrix(c(tp, fn, fp, tn), ncol=2, byrow=TRUE)
colnames(conf_matrix) <- c("Predicted Positive", "Predicted Negative")
rownames(conf_matrix) <- c("Observed Positive", "Observed Negative")
conf_matrix

conf_matrix_perc <- matrix(c(tpr, fnr, fpr, tnr), ncol=2, byrow=TRUE)
colnames(conf_matrix_perc) <- c("Predicted Positive", "Predicted Negative")
rownames(conf_matrix_perc) <- c("Observed Positive", "Observed Negative")
conf_matrix_perc

```


#### Cropland + Mosaic ag

Check how overlap and confusion matrix change if mosaic ag and pasture is included into MapBiomas 2020 data
```{r}
# reusing same chen data, so only need to redo for mapbiomas
# convert raster to vector
vals_mapbio_mosaic <- terra::values(mapbiomas_crop_2020_mosaic)

#turn vects into factors of same length
expected_val_2020_mosaic <- factor(vals_mapbio_mosaic)
 
#Create confusion matrix
cm_chen_mapbio_2020_mosaic <- confusionMatrix(data=predicted_val_2020, reference = expected_val_2020_mosaic)
 
#Display results 
cm_chen_mapbio_2020_mosaic
table(expected_val_2020, predicted_val_2020_mosaic)
```


```{r}
# add chen and mapbiomas rasters 
chen_mapbiomas_mosaic_crop_2020 <- mapbiomas_crop_2020_mosaic + chen_crop_ssp1_2020_brazil
plot(chen_mapbiomas_mosaic_crop_2020)

# return frequency of each value (0, 1, 10, 11) in new raster
counts <- freq(chen_mapbiomas_mosaic_crop_2020)
counts

# break up freq values ba
nocrop <- counts[1, 3]
crop_mapbiomas_only <- counts[2, 3]
crop_chen_only <- counts[3,3]
crop_both <- counts[4,3]

# determine total number of pixels with values for calculating percentages later
total <- nocrop + crop_mapbiomas_only + crop_chen_only + crop_both
total



# break down into values for confusion matrix

# number of real positive cases (P), pixels for which mapbiomas observed cropland
p <- crop_mapbiomas_only + crop_both
# number of real negative cases (N), pixels for which mapbiomas did not observe cropland
n <- nocrop + crop_chen_only

# true positive
tp <- crop_both
# false positive
fp <- crop_chen_only
# true negative
tn <- nocrop
# false negative
fn <- crop_mapbiomas_only

#percentages:
# sensitivity (true positive rate)
tpr <- tp/p
# specificity (true negative rate)
tnr <- tn/n
# false positive rate
fpr <- fp/n
# false negative rate
fnr <- fn/p


conf_matrix <- matrix(c(tp, fn, fp, tn), ncol=2, byrow=TRUE)
colnames(conf_matrix) <- c("Predicted Positive", "Predicted Negative")
rownames(conf_matrix) <- c("Observed Positive", "Observed Negative")
conf_matrix

conf_matrix_perc <- matrix(c(tpr, fnr, fpr, tnr), ncol=2, byrow=TRUE)
colnames(conf_matrix_perc) <- c("Predicted Positive", "Predicted Negative")
rownames(conf_matrix_perc) <- c("Observed Positive", "Observed Negative")
conf_matrix_perc
```



### Cao vs. Mapbiomas




## Checking baseline

Checking the sensitivity and specificity of Chen vs Mapbiomas for 2015, both considered "observed" models.

First read in, crop, mask, and reclassify 2015 Chen raster
```{r}
# read in GeoTiff for 2015 Chen
chen_2015_global <- rast("data/chen/global_PFT_2015.tif")


# crop and mask chen data to brazil_trans vector, then project back to our desired crs
chen_2015_brazil <- chen_2015_global %>% 
  crop(brazil_trans) %>% 
  mask(brazil_trans) %>% 
  terra::project(y = crs(brazil))

# isolate just cropland from the raster
chen_crop_2015_brazil <- chen_2015_brazil
chen_crop_2015_brazil[chen_crop_2015_brazil != 18] <- 0 # if value isn't 18, make 0
chen_crop_2015_brazil[chen_crop_2015_brazil == 18] <- 10 # if value is 18, make 10

#plot(chen_crop_2015_brazil)
```

Next read in, crop, mask, and reclassify 2015 MapBiomas raster
```{r}
# WARNING: below analysis (aggregate step) will take a long time to run!
# Once run, the last line of code in this chunk will save the intermediate raster locally.
# If this has been already run once, skip running this chunk and move on to next


# read in GeoTiff
mapbiomas_2015 <- rast("data/mapbiomas/mapbiomas_brasil_coverage_2015.tif")

# change resolution from 30m to roughly 1km
# to figure out factor that gets res closest to target raster (Chen), use this:
    factor <- ceiling(res(chen_crop_2015_brazil)[1]/res(mapbiomas_2015)[1])
    factor

# now change resolution using terra:aggregate()
mapbiomas_2015_agg <- aggregate(mapbiomas_2015,   #raster 
                            fact = 34,            #agg factor (positive int)
                            fun = "modal",        #categorical values in raster
                            na.rm = TRUE)         #don't drop entire aggregation bc of one NA

# resample lower res mapbiomas using Chen data to ensure same resolution (fine-tuning the res)
mapbiomas_2015_resamp <- resample(mapbiomas_2015_agg, chen_crop_2015_brazil, method = "near")

# because crs of mapbiomas and chen rasters are different, repeat process of
# transforming brazil for purposes of cropping and masking
brazil_trans2 <- brazil %>% 
  st_transform(crs = crs(mapbiomas_2015_resamp)) %>% 
  vect() 

# crop and mask mapbiomas layer to ROI
mapbiomas_2015_cropped <- mapbiomas_2015_resamp %>% 
  crop(brazil_trans2, mask = TRUE)

# save intermediate raster
writeRaster(mapbiomas_2015_cropped, "data/mapbiomas/mapbiomas_2015_cropped.tif")

```

Reclassify both excluding and including mosaic cropland and pasture:
```{r}
# read in raster if previous chunk has already been run:
mapbiomas_2015_cropped <- rast("data/mapbiomas/mapbiomas_2015_cropped.tif")

# use terra:classify() to reclassify raster values based on matrix
# first use matrix excluding mosaic cropland
mapbiomas_2015_reclass <- classify(mapbiomas_2015_cropped, reclass_m)
# use terra::project() to match with chen raster
mapbiomas_crop_2015 <- project(mapbiomas_2015_reclass, crs(chen_crop_2015_brazil), method = "near")


# now use matrix including mosaic cropland
mapbiomas_2015_reclass_mosaic <- classify(mapbiomas_2015_cropped, reclass_m_mosaic)
# project to chen raster
mapbiomas_crop_2015_mosaic <- project(mapbiomas_2015_reclass_mosaic, crs(chen_crop_2015_brazil), method = "near")
```



Now calculate confusion matrix for 2015 datasets
```{r}
# add chen and mapbiomas rasters 
chen_mapbiomas_crop_2015 <- mapbiomas_crop_2015 + chen_crop_2015_brazil
plot(chen_mapbiomas_crop_2015)

# return frequency of each value (0, 1, 10, 11) in new raster
counts2015 <- freq(chen_mapbiomas_crop_2015)
counts2015

# break up freq values ba
nocrop_2015 <- counts2015[1, 3]
crop_mapbiomas_only_2015 <- counts2015[2, 3]
crop_chen_only_2015 <- counts2015[3,3]
crop_both_2015 <- counts2015[4,3]

# determine total number of pixels with values for calculating percentages later
total_2015 <- nocrop_2015 + crop_mapbiomas_only_2015 + crop_chen_only_2015 + crop_both_2015
total_2015



# break down into values for confusion matrix

# number of real positive cases (P), pixels for which mapbiomas observed cropland
p2 <- crop_mapbiomas_only_2015 + crop_both_2015
# number of real negative cases (N), pixels for which mapbiomas did not observe cropland
n2 <- nocrop_2015 + crop_chen_only_2015

# true positive
tp2 <- crop_both_2015
# false positive
fp2 <- crop_chen_only_2015
# true negative
tn2 <- nocrop_2015
# false negative
fn2 <- crop_mapbiomas_only_2015

#percentages:
# sensitivity (true positive rate)
tpr2 <- tp2/p2
# specificity (true negative rate)
tnr2 <- tn2/n2
# false positive rate
fpr2 <- fp2/n2
# false negative rate
fnr2 <- fn2/p2


conf_matrix_2015 <- matrix(c(tp2, fn2, fp2, tn2), ncol=2, byrow=TRUE)
colnames(conf_matrix_2015) <- c("Predicted Positive", "Predicted Negative")
rownames(conf_matrix_2015) <- c("Observed Positive", "Observed Negative")
conf_matrix_2015

conf_matrix_perc_2015 <- matrix(c(tpr2, fnr2, fpr2, tnr2), ncol=2, byrow=TRUE)
colnames(conf_matrix_perc_2015) <- c("Predicted Positive", "Predicted Negative")
rownames(conf_matrix_perc_2015) <- c("Observed Positive", "Observed Negative")
conf_matrix_perc_2015
```


Compare against mosaic ag
```{r}
# add chen and mapbiomas rasters 
chen_mapbiomas_mosaic_crop_2015 <- mapbiomas_crop_2015_mosaic + chen_crop_2015_brazil
plot(chen_mapbiomas_mosaic_crop_2015)

# return frequency of each value (0, 1, 10, 11) in new raster
counts2015 <- freq(chen_mapbiomas_mosaic_crop_2015)
counts2015

# break up freq values ba
nocrop_2015 <- counts2015[1, 3]
crop_mapbiomas_only_2015 <- counts2015[2, 3]
crop_chen_only_2015 <- counts2015[3,3]
crop_both_2015 <- counts2015[4,3]

# determine total number of pixels with values for calculating percentages later
total_2015 <- nocrop_2015 + crop_mapbiomas_only_2015 + crop_chen_only_2015 + crop_both_2015
total_2015



# break down into values for confusion matrix

# number of real positive cases (P), pixels for which mapbiomas observed cropland
p2 <- crop_mapbiomas_only_2015 + crop_both_2015
# number of real negative cases (N), pixels for which mapbiomas did not observe cropland
n2 <- nocrop_2015 + crop_chen_only_2015

# true positive
tp2 <- crop_both_2015
# false positive
fp2 <- crop_chen_only_2015
# true negative
tn2 <- nocrop_2015
# false negative
fn2 <- crop_mapbiomas_only_2015

#percentages:
# sensitivity (true positive rate)
tpr2 <- tp2/p2
# specificity (true negative rate)
tnr2 <- tn2/n2
# false positive rate
fpr2 <- fp2/n2
# false negative rate
fnr2 <- fn2/p2


conf_matrix_2015 <- matrix(c(tp2, fn2, fp2, tn2), ncol=2, byrow=TRUE)
colnames(conf_matrix_2015) <- c("Predicted Positive", "Predicted Negative")
rownames(conf_matrix_2015) <- c("Observed Positive", "Observed Negative")
conf_matrix_2015

conf_matrix_perc_2015 <- matrix(c(tpr2, fnr2, fpr2, tnr2), ncol=2, byrow=TRUE)
colnames(conf_matrix_perc_2015) <- c("Predicted Positive", "Predicted Negative")
rownames(conf_matrix_perc_2015) <- c("Observed Positive", "Observed Negative")
conf_matrix_perc_2015
```


